@* @model InvoiceView

<div class="center-box">
    <form id="addProductForm">
        <input type="hidden" value="@Model.PartyID" id="partyId" />

        <!-- Party -->
        <div class="form-field flex">
            <div class="w-25">
                <label for="Party" class="form-label pt">Party</label>
            </div>
            <div class="flex-1">
                <input class="form-input" readonly value="@Model.PartyName">
                <span class="text-red"></span>
            </div>
        </div>

        <!-- Product with Quantity Inputs -->
        @foreach (var product in ViewBag.products)
        {
            <div class="form-field flex">
                <div class="w-25">
                    <label class="form-label pt">@product.ProductName</label>
                </div>
                <div class="flex-1">
                    <input type="hidden" name="Products[@product.ProductId].ProductId" value="@product.ProductId" />
                    <input type="number" class="form-input" name="Products[@product.ProductId].Quantity" placeholder="Quantity" min="0" required>
                    <span class="text-red"></span>
                </div>
            </div>
        }

        <!-- Submit -->
        <div class="form-field flex">
            <div class="w-25"></div>
            <div class="flex-1">
                <button type="submit" class="button button-green-back">Create</button>
                <div asp-validation-summary="All" class="text-red"></div>
            </div>
        </div>
    </form>

    <!-- Invoice Display Section -->
    <div id="invoice-result" class="invoice-box"></div>
</div>

<script>
    $(document).ready(function() {
        $('#addProductForm').on('submit', function(e) {
            e.preventDefault();

            const formData = $(this).serialize();

            $.ajax({
                url: '@Url.Action("Create", "Invoices")',
                method: 'POST',
                data: formData,
                success: function(response) {
                    // Render the invoice below the form
                    $('#invoice-result').html(response);
                },
                error: function() {
                    alert('There was an error generating the invoice.');
                }
            });
        });
    });
</script>
 *@


@* @model List<ProductsManagementSystem.DTO.InvoiceRequest>
@{
    ViewBag.Title = "Create Invoice";
    var assignedProducts = ViewBag.AssignedProducts;
    var invoiceResponse = ViewBag.InvoiceResponse;
    int index = 0;
}

<h2>Create Invoice</h2>

<form asp-action="Create" asp-controller="Invoices" method="post">
<!--<form asp-action="Create" method="post"> -->
    <input type="hidden" name="PartyId" value="@ViewBag.PartyId" />

    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in assignedProducts)
            {
                <tr>
                    <td>@product.ProductName</td>
                    <td>
                        <input type="hidden" name="invoiceRequests[@index].ProductId" value="@product.ProductID" />
                        <input type="number" name="invoiceRequests[@index].Quantity" class="form-control" min="1" value="1" />
                    </td>
                </tr>
                index++;
            }
        </tbody>
    </table>

    <button type="submit" class="btn btn-primary">Create Invoice</button>
</form>

@if (invoiceResponse != null)
{
    <h3>Invoice Generated</h3>
    <p><strong>Party Name:</strong> @invoiceResponse.PartyName</p>
    <p><strong>Total Amount:</strong> $@invoiceResponse.Total</p>

    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var detail in invoiceResponse.InvoiceDetails)
            {
                <tr>
                    <td>@detail.ProductName</td>
                    <td>@detail.Quantity</td>
                    <td>$@detail.Price</td>
                    <td>$@(detail.Quantity * detail.Price)</td>
                </tr>
            }
        </tbody>
    </table>
}  *@

@model InvoiceView
@{
    ViewBag.Title = "Invoice";
}

<h1>Invoices</h1>


<div class="center-box">
    <form id="addProductForm">
        <input type="hidden" value="@Model.PartyID" id="partyId" />

        <!-- Party -->
        <div class="form-field flex">
            <div class="w-25">
                <label for="Party" class="form-label pt">Party</label>
            </div>
            <div class="flex-1">
                @{
                    if (Model.PartyID == 0)
                    {
                        <select class="form-input" id="party-selection">
                            <option value="">Select Party</option>
                            @foreach (var party in ViewBag.Party)
                            {
                                <option value="@party.Value">@party.Text</option>
                            }
                        </select>
                    }
                    else
                    {
                        <input class="form-input" readonly value="@Model.PartyName">
                    }
                }
                <span class="text-red"></span>
            </div>
        </div>

        @foreach (var product in ViewBag.products)
        {
            <div class="form-field flex">
                <!-- Product Name as a label -->
                <div class="w-25">
                    <label class="form-label pt ">@product.ProductName</label>
                </div>

                <!-- Quantity Input -->
                <div class="flex-1">
                    <input type="hidden" name="Products[@product.ProductId].ProductId" value="@product.ProductId" />
                    <input type="number" class="form-input" name="Products[@product.ProductId].Quantity" id="quantity-@product.ProductId" value="0" placeholder="0" min="0" required>
                    <span class="text-red"></span>
                </div>
            </div>
        }

        <!-- Price -->
        @* <div class="form-field flex">
        <div class="w-25">
        <label for="Price" class="form-label pt">Price</label>
        </div>
        <div class="flex-1">
        <input type="number" class="form-input" id="price" placeholder="Price" readonly>
        <span class="text-red"></span>
        </div>
        </div> *@

        <!-- Submit Button -->
        <div class="form-field flex">
            <div class="w-25"></div>
            <div class="flex-1">
                <button type="submit" id="AddBtn" class="button button-green-back">Add</button>
                <div asp-validation-summary="All" class="text-red"></div>
            </div>
        </div>

        @* <div class="form-field flex">
        <div class="w-25"></div>
        <div class="flex-1">
        <button class="btn btn-secondary" id="generateInvoiceButton">Generate Invoice</button>
        </div>

        </div> *@

    </form>
</div>


<div class="center-box">
    <h3>Invoive Details</h3>

    <table class="table w-100 mt" id="InvoiceProdcuts">
        <thead>
            <tr>
                <th>Product Id</th>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Sub Total</th>
            </tr>
        </thead>
        <tbody id="invoiceBody">

        </tbody>
    </table><br /><br />

    <div class="d-flex justify-content-end">
        <button class="btn btn-primary" id="generateInvoiceButton">Create Invoice</button>

    </div>

</div>

@section Scripts {
    <script>
        var invoiceData = [];
        var partyId = $('#partyId').val();

        $(document).ready(function () {
            var products = @Html.Raw(Json.Serialize(ViewBag.products));

            console.log(products);

            $('#addProductForm').on('submit', function (event) {
                event.preventDefault();

                $('#InvoiceProducts tbody').empty();
                $('#AddBtn').prop('disabled', true);

                products.forEach(function (product) {
                    var productId = product.productId;
                    var productName = product.productName;
                    var price = parseFloat(product.price);
                    var quantityInput = $('#quantity-' + productId);
                    var quantity = parseInt(quantityInput.val());


                    if (quantity > 0) {
                        var subtotal = quantity * price;

                        // Append new row to the invoice table
                        $('#invoiceBody').append(
                            '<tr>' +
                            '<td>' + productId + '</td>' +
                            '<td>' + productName + '</td>' +
                            '<td>' + quantity + '</td>' +
                            '<td>' + price.toFixed(2) + '</td>' +
                            '<td>' + subtotal.toFixed(2) + '</td>' +
                            '</tr>'
                        );

                        // Add product data to invoiceData array
                        invoiceData.push({
                            partyId: parseInt(partyId),
                            ProductId: productId,
                            ProductName: productName,
                            Quantity: quantity,
                            Price: price,
                            Subtotal: subtotal
                        });
                    }
                });
                $('#AddBtn').prop('disabled', true);
            });

            $('#generateInvoiceButton').on('click', function (event) {
                event.preventDefault();

                console.log(invoiceData);

                if (invoiceData.length === 0) {
                    alert('Add at least one product');
                    return;
                }

                $.ajax({
                    url: '/Invoices/CreateInvoice',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(invoiceData),
                    success: function (response) {
                        alert('Invoice created successfully!');
                        window.location.href = "/Invoices/Index";
                    },
                    error: function (xhr, status, error) {
                        console.log(xhr);
                        console.log(status);
                        console.log(error);
                        alert('Error: ' + error);
                    }
                });
            });
        });
    </script>

} 